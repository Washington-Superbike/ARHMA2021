<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="__pre_charge_8ino_source" xml:lang="en-US">
<title>PreCharge.ino</title>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="__pre_charge_8ino_source_1l00001"/>00001 
<anchor xml:id="__pre_charge_8ino_source_1l00025"/>00025 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="__precharge_8h">Precharge.h</link>&quot;</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00026"/>00026 <emphasis role="preprocessor">#include&#32;&lt;Wire.h&gt;</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00027"/>00027 
<anchor xml:id="__pre_charge_8ino_source_1l00028"/>00028 <emphasis role="comment">//&#32;I2C&#32;is&#32;incredibly&#32;unstable?&#32;Or&#32;perhaps&#32;not&#32;using&#32;proper&#32;wiring&#32;causes&#32;this,</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00029"/>00029 <emphasis role="comment">//&#32;but&#32;the&#32;reading&#32;in&#32;precharge&#32;data&#32;can&#32;often&#32;bug&#32;out&#32;and&#32;output</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00030"/>00030 <emphasis role="comment">//&#32;&quot;nan&quot;&#32;because&#32;of&#32;randomness?&#32;I&#32;would&#32;personally&#32;recommend</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00031"/>00031 <emphasis role="comment">//&#32;having&#32;some&#32;sort&#32;of&#32;true&#32;or&#32;false&#32;based</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00032"/>00032 <emphasis role="comment">//&#32;indicator&#32;at&#32;the&#32;bottom&#32;right&#32;of&#32;the&#32;speedometer&#32;screen</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00033"/>00033 <emphasis role="comment">//&#32;that&#32;outputs&#32;&quot;true&quot;&#32;or&#32;something&#32;to&#32;indicate</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00034"/>00034 <emphasis role="comment">//&#32;that&#32;the&#32;gyro&#32;is&#32;not&#32;bugging&#32;out.&#32;Or&#32;perhaps</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00035"/>00035 <emphasis role="comment">//&#32;output&#32;the&#32;gyro&#32;data&#32;on&#32;the&#32;bottom&#32;right</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00036"/>00036 <emphasis role="comment">//&#32;to&#32;indicate&#32;danger?&#32;Something&#32;like&#32;that.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00037"/>00037 
<anchor xml:id="__pre_charge_8ino_source_1l00038"/>00038 <emphasis role="comment">//&#32;OKAY,&#32;MAKE&#32;SURE&#32;YOU&#32;READ&#32;THIS&#32;IF&#32;YOU&#32;SEE&#32;ISSUES&#32;WITH&#32;THE&#32;GYRO.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00039"/>00039 <emphasis role="comment">//&#32;By&#32;my&#32;*limited*&#32;understanding,&#32;I&#32;think&#32;the&#32;problem&#32;is&#32;that</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00040"/>00040 <emphasis role="comment">//&#32;the&#32;gyro&#32;needs&#32;to&#32;be&#32;consistently&#32;powered,&#32;hence&#32;why&#32;proper</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00041"/>00041 <emphasis role="comment">//&#32;gyro&#32;setup&#32;code&#32;has&#32;a&#32;significant&#32;delay&#32;between</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00042"/>00042 <emphasis role="comment">//&#32;turning&#32;the&#32;thing&#32;on&#32;and&#32;actually&#32;reading&#32;data&#32;from&#32;it.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00043"/>00043 <emphasis role="comment">//&#32;An&#32;easy&#32;way&#32;to&#32;work&#32;around&#32;it,&#32;is&#32;to&#32;power&#32;on&#32;the&#32;Teensy</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00044"/>00044 <emphasis role="comment">//&#32;and&#32;then&#32;once&#32;everything&#32;is&#32;up&#32;and&#32;running,</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00045"/>00045 <emphasis role="comment">//&#32;reprogram&#32;it&#32;by&#32;using&#32;the&#32;button&#32;on&#32;the&#32;board.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00046"/>00046 <emphasis role="comment">//&#32;In&#32;the&#32;case&#32;of&#32;the&#32;actual&#32;race,&#32;I&#32;would&#32;turn&#32;on&#32;low-voltage</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00047"/>00047 <emphasis role="comment">//&#32;and&#32;then&#32;wait&#32;a&#32;second&#32;and&#32;then&#32;turn&#32;it&#32;off&#32;and&#32;then</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00048"/>00048 <emphasis role="comment">//&#32;turn&#32;it&#32;back&#32;on.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00049"/>00049 
<anchor xml:id="__pre_charge_8ino_source_1l00050"/>00050 <emphasis role="comment">//&#32;The&#32;state&#32;HV_PRECHARGING,&#32;HV_ON&#32;are&#32;badly&#32;named.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00051"/>00051 <emphasis role="comment">//&#32;The&#32;enum&#32;should&#32;be&#32;renamed&#32;to&#32;HV_STATE</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00052"/>00052 <emphasis role="comment">//&#32;and&#32;instead&#32;we&#32;should&#32;have&#32;HV_OFF,&#32;HV_ON,&#32;HV_ON&#32;states</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00053"/>00053 
<anchor xml:id="__pre_charge_8ino_source_1l00054"/><link linkend="__pre_charge_8ino_1a2cd6f5c27d7667dbd0b6a0bc756340a3">00054</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1a2cd6f5c27d7667dbd0b6a0bc756340a3">prechargeTask</link>(<emphasis role="keywordtype">void</emphasis>&#32;*taskData)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00055"/>00055 &#32;&#32;<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;prechargeData&#32;=&#32;*(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;*)taskData;
<anchor xml:id="__pre_charge_8ino_source_1l00056"/>00056 &#32;&#32;<emphasis role="keywordflow">while</emphasis>&#32;(1)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00057"/>00057 &#32;&#32;&#32;&#32;<link linkend="__pre_charge_8ino_1ad2376a25ab645f00587791af3c89968e">preChargeCircuitFSMStateActions</link>(prechargeData);
<anchor xml:id="__pre_charge_8ino_source_1l00058"/>00058 &#32;&#32;&#32;&#32;<link linkend="__pre_charge_8ino_1ad5e3efaa785dcd1d9143ec7e5d117277">preChargeCircuitFSMTransitions</link>(prechargeData);
<anchor xml:id="__pre_charge_8ino_source_1l00059"/>00059 &#32;&#32;&#32;&#32;<link linkend="__pre_charge_8ino_1a87184d718be6821c71e697fc1fd98d3b">updateGyroData</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>);
<anchor xml:id="__pre_charge_8ino_source_1l00060"/>00060 
<anchor xml:id="__pre_charge_8ino_source_1l00061"/>00061 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;100&#32;ms&#32;should&#32;be&#32;unnoticeable&#32;compared&#32;to&#32;other&#32;task&#32;updates</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00062"/>00062 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;but&#32;should&#32;be&#32;fast&#32;to&#32;pick&#32;up&#32;errors&#32;/&#32;switch&#32;updates</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00063"/>00063 &#32;&#32;&#32;&#32;<link linkend="_task_8h_1aa154068cecd7f31446a7a84af44ab1a3">vTaskDelay</link>((1&#32;*&#32;<link linkend="__free_r_t_o_s_config__default_8h_1a2f0258dd1e3b877e5bc013be54c2db6a">configTICK_RATE_HZ</link>)&#32;/&#32;1000);
<anchor xml:id="__pre_charge_8ino_source_1l00064"/>00064 &#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00065"/>00065 }
<anchor xml:id="__pre_charge_8ino_source_1l00066"/>00066 
<anchor xml:id="__pre_charge_8ino_source_1l00067"/>00067 <emphasis role="comment">//&#32;NOTE:&#32;&quot;input&quot;&#32;needs&#32;to&#32;change&#32;to&#32;the&#32;GPIO&#32;value&#32;for&#32;the&#32;on-button&#32;for&#32;the&#32;bike</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00068"/><link linkend="__precharge_8h_1ad5e3efaa785dcd1d9143ec7e5d117277">00068</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1ad5e3efaa785dcd1d9143ec7e5d117277">preChargeCircuitFSMTransitions</link>&#32;(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00069"/>00069 &#32;&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29">HV_STATE</link>&#32;old_state&#32;=&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00070"/>00070 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>)&#32;{&#32;<emphasis role="comment">//&#32;transitions</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00071"/>00071 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00072"/>00072 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="__pre_charge_8ino_1a6798f4bd0a5b6353886f894b38b32473">check_HV_TOGGLE</link>())&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00073"/>00073 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2da9fa3988c31a60d94ee2a751ba32ce">HV_PRECHARGING</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00074"/>00074 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00075"/>00075 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00076"/>00076 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2da9fa3988c31a60d94ee2a751ba32ce">HV_PRECHARGING</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00077"/>00077 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="__pre_charge_8ino_1a6798f4bd0a5b6353886f894b38b32473">check_HV_TOGGLE</link>())&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00078"/>00078 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;kill-switch&#32;activated&#32;or&#32;HV&#32;switch&#32;turned&#32;off</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00079"/>00079 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00080"/>00080 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00081"/>00081 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="__pre_charge_8ino_1a65867cb936f7ef47ffd07fbfd4a91355">isHVSafe</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>))&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00082"/>00082 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;HV&#32;error&#32;detected</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00083"/>00083 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2303713b8a2ce365abb6b0de95c38595">HV_ERROR</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00084"/>00084 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00085"/>00085 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="__pre_charge_8ino_1a42b25fa6ccd2c8d82ba24c5ed4aaa7d1">isPrecharged</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>))&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00086"/>00086 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;finished&#32;precharging</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00087"/>00087 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29ab5febf14562b68ff6bdaaa86ec9b5dec">HV_ON</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00088"/>00088 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00089"/>00089 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00090"/>00090 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;no&#32;updates,&#32;keep&#32;precharging</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00091"/>00091 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2da9fa3988c31a60d94ee2a751ba32ce">HV_PRECHARGING</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00092"/>00092 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00093"/>00093 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00094"/>00094 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29ab5febf14562b68ff6bdaaa86ec9b5dec">HV_ON</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00095"/>00095 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;&#32;TODO:&#32;add&#32;another&#32;&amp;&amp;&#32;next&#32;to&#32;the&#32;!check_HV_TOGGLE,&#32;that&#32;essentially&#32;checks&#32;the&#32;measured&#32;angle&#32;&gt;&#32;45&#32;degrees&#32;on&#32;left&#32;or&#32;right&#32;side&#32;(+-&#32;45&#32;degrees?)</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00096"/>00096 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="__pre_charge_8ino_1a6798f4bd0a5b6353886f894b38b32473">check_HV_TOGGLE</link>()&#32;||&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a7a48fc6887285d4cb55bff65fca23f36">angle_Y</link>&#32;&gt;&#32;45&#32;||&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a7a48fc6887285d4cb55bff65fca23f36">angle_Y</link>&#32;&lt;&#32;-45&#32;||&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a53289d52f48c067285cb843ef7470c9a">angle_X</link>&#32;&gt;&#32;45&#32;||&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a53289d52f48c067285cb843ef7470c9a">angle_X</link>&#32;&lt;&#32;-45)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00097"/>00097 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;kill-switch&#32;activated&#32;or&#32;HV&#32;switch&#32;turned&#32;off</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00098"/>00098 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00099"/>00099 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00100"/>00100 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;<emphasis role="keywordflow">if</emphasis>&#32;(!<link linkend="__pre_charge_8ino_1a65867cb936f7ef47ffd07fbfd4a91355">isHVSafe</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>))&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00101"/>00101 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;HV&#32;error&#32;detected</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00102"/>00102 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2303713b8a2ce365abb6b0de95c38595">HV_ERROR</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00103"/>00103 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00104"/>00104 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00105"/>00105 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;no&#32;updates,&#32;keep&#32;HV&#32;on</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29ab5febf14562b68ff6bdaaa86ec9b5dec">HV_ON</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00107"/>00107 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00108"/>00108 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00109"/>00109 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2303713b8a2ce365abb6b0de95c38595">HV_ERROR</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00110"/>00110 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="__pre_charge_8ino_1a65867cb936f7ef47ffd07fbfd4a91355">isHVSafe</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>))&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00111"/>00111 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;if&#32;the&#32;error&#32;has&#32;been&#32;cleared</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00112"/>00112 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00113"/>00113 &#32;&#32;&#32;&#32;&#32;&#32;}&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00114"/>00114 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;otherwise&#32;stay&#32;here</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00115"/>00115 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2303713b8a2ce365abb6b0de95c38595">HV_ERROR</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00116"/>00116 &#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00117"/>00117 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00118"/>00118 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:
<anchor xml:id="__pre_charge_8ino_source_1l00119"/>00119 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;=&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00120"/>00120 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00121"/>00121 &#32;&#32;}&#32;<emphasis role="comment">//&#32;transitions</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00122"/>00122 
<anchor xml:id="__pre_charge_8ino_source_1l00123"/>00123 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>&#32;!=&#32;old_state)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00124"/>00124 &#32;&#32;&#32;&#32;Serial.printf(<emphasis role="stringliteral">&quot;HV&#32;transitioned&#32;from&#32;%s&#32;to&#32;%s&#32;state\n&quot;</emphasis>,&#32;<link linkend="__pre_charge_8ino_1a0a3e1d4e80c1320d3308a0e0bb10ac87">state_name</link>(old_state),&#32;<link linkend="__pre_charge_8ino_1a0a3e1d4e80c1320d3308a0e0bb10ac87">state_name</link>(<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>));
<anchor xml:id="__pre_charge_8ino_source_1l00125"/>00125 &#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00126"/>00126 }
<anchor xml:id="__pre_charge_8ino_source_1l00127"/>00127 
<anchor xml:id="__pre_charge_8ino_source_1l00128"/><link linkend="__precharge_8h_1ad2376a25ab645f00587791af3c89968e">00128</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1ad2376a25ab645f00587791af3c89968e">preChargeCircuitFSMStateActions</link>&#32;(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00129"/>00129 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(<link linkend="__precharge_8h_1a5c9b1f4b5a31b5d46c45310567595867">hv_state</link>)&#32;{&#32;<emphasis role="comment">//&#32;state&#32;actions</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00130"/>00130 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00131"/>00131 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1ae1099ac76283225ff2bbbbdc0819ba4e">CONTACTOR</link>,&#32;LOW);
<anchor xml:id="__pre_charge_8ino_source_1l00132"/>00132 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1a093dd273c900bae9cba2b32149e30eaa">PRECHARGE</link>,&#32;LOW);
<anchor xml:id="__pre_charge_8ino_source_1l00133"/>00133 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00134"/>00134 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2da9fa3988c31a60d94ee2a751ba32ce">HV_PRECHARGING</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00135"/>00135 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1ae1099ac76283225ff2bbbbdc0819ba4e">CONTACTOR</link>,&#32;LOW);
<anchor xml:id="__pre_charge_8ino_source_1l00136"/>00136 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1a093dd273c900bae9cba2b32149e30eaa">PRECHARGE</link>,&#32;HIGH);
<anchor xml:id="__pre_charge_8ino_source_1l00137"/>00137 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00138"/>00138 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29ab5febf14562b68ff6bdaaa86ec9b5dec">HV_ON</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00139"/>00139 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1ae1099ac76283225ff2bbbbdc0819ba4e">CONTACTOR</link>,&#32;HIGH);
<anchor xml:id="__pre_charge_8ino_source_1l00140"/>00140 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1a093dd273c900bae9cba2b32149e30eaa">PRECHARGE</link>,&#32;LOW);
<anchor xml:id="__pre_charge_8ino_source_1l00141"/>00141 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00142"/>00142 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2303713b8a2ce365abb6b0de95c38595">HV_ERROR</link>:
<anchor xml:id="__pre_charge_8ino_source_1l00143"/>00143 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1ae1099ac76283225ff2bbbbdc0819ba4e">CONTACTOR</link>,&#32;LOW);
<anchor xml:id="__pre_charge_8ino_source_1l00144"/>00144 &#32;&#32;&#32;&#32;&#32;&#32;digitalWrite(<link linkend="__precharge_8h_1a093dd273c900bae9cba2b32149e30eaa">PRECHARGE</link>,&#32;LOW);
<anchor xml:id="__pre_charge_8ino_source_1l00145"/>00145 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">default</emphasis>:
<anchor xml:id="__pre_charge_8ino_source_1l00146"/>00146 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">break</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00147"/>00147 &#32;&#32;}&#32;<emphasis role="comment">//&#32;state&#32;actions</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00148"/>00148 }
<anchor xml:id="__pre_charge_8ino_source_1l00149"/>00149 
<anchor xml:id="__pre_charge_8ino_source_1l00150"/>00150 <emphasis role="comment">//&#32;Returns&#32;true&#32;if&#32;the&#32;motor&#32;controller&#32;is&#32;done&#32;precharging.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00151"/>00151 <emphasis role="comment">//&#32;Returns&#32;false&#32;otherwise.</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00152"/><link linkend="__precharge_8h_1a42b25fa6ccd2c8d82ba24c5ed4aaa7d1">00152</link> <emphasis role="keywordtype">bool</emphasis>&#32;<link linkend="__pre_charge_8ino_1a42b25fa6ccd2c8d82ba24c5ed4aaa7d1">isPrecharged</link>(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00153"/>00153 
<anchor xml:id="__pre_charge_8ino_source_1l00154"/>00154 &#32;&#32;<emphasis role="comment">//&#32;Ret&#32;false&#32;if&#32;we&#32;haven&apos;t&#32;received&#32;all&#32;BMS&#32;cell&#32;voltages&#32;yet</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00155"/>00155 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afdfc29c3040101593d7d298c7b432132">cellVoltages</link>.<link linkend="_struct_cell_voltages_1a844b5b2d0bd58e1147076ab8aacc420a">ready</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00156"/>00156 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keyword">false</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00157"/>00157 &#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00158"/>00158 
<anchor xml:id="__pre_charge_8ino_source_1l00159"/>00159 &#32;&#32;<emphasis role="comment">//&#32;Ret&#32;true&#32;if&#32;the&#32;difference&#32;between&#32;the&#32;main-accumulator-series-voltage&#32;and&#32;the</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00160"/>00160 &#32;&#32;<emphasis role="comment">//&#32;motorcontroller-voltage&#32;is&#32;less&#32;than&#32;10%&#32;of&#32;the&#32;main-accumulator-series-voltage</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00161"/>00161 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;((*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afdfc29c3040101593d7d298c7b432132">cellVoltages</link>.<link linkend="_struct_cell_voltages_1a739cccc4cfe6c366e7474ae1c71097bf">seriesVoltage</link>&#32;-&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aae4496a1b8d72f6107bdfcf81472741b">motorControllerBatteryVoltage</link>)&#32;&lt;=&#32;(*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afdfc29c3040101593d7d298c7b432132">cellVoltages</link>.<link linkend="_struct_cell_voltages_1a739cccc4cfe6c366e7474ae1c71097bf">seriesVoltage</link>&#32;*&#32;0.1)&#32;&amp;&amp;
<anchor xml:id="__pre_charge_8ino_source_1l00162"/>00162 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//and&#32;main-accumulator-voltage&#32;is&#32;greater&#32;than&#32;80V&#32;(but&#32;this&#32;should&#32;be&#32;changed&#32;later&#32;as&#32;the&#32;bike&#32;voltage&#32;may&#32;be&#32;as&#32;low&#32;as&#32;~60V).</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00163"/>00163 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afdfc29c3040101593d7d298c7b432132">cellVoltages</link>.<link linkend="_struct_cell_voltages_1a739cccc4cfe6c366e7474ae1c71097bf">seriesVoltage</link>&#32;&gt;&#32;80);
<anchor xml:id="__pre_charge_8ino_source_1l00164"/>00164 }
<anchor xml:id="__pre_charge_8ino_source_1l00165"/>00165 
<anchor xml:id="__pre_charge_8ino_source_1l00166"/>00166 <emphasis role="comment">//&#32;this&#32;function&#32;returns&#32;true&#32;if&#32;there&#32;are&#32;no&#32;HV&#32;errors&#32;detected&#32;on&#32;the&#32;bike</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00167"/><link linkend="__precharge_8h_1a65867cb936f7ef47ffd07fbfd4a91355">00167</link> <emphasis role="keywordtype">bool</emphasis>&#32;<link linkend="__pre_charge_8ino_1a65867cb936f7ef47ffd07fbfd4a91355">isHVSafe</link>(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00168"/>00168 &#32;&#32;<emphasis role="comment">//BMSStatus&#32;bmsStatus&#32;=&#32;preChargeData.bmsStatus;</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00169"/>00169 &#32;&#32;<link linkend="_struct_motor_temps">MotorTemps</link>&#32;<link linkend="__main_8h_1abb61c6dc61d12b31aad7bdadd495b70a">motorTemps</link>&#32;=&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a3e8e3c4386b66dbf1011082b1f8ce7aa">motorTemps</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00170"/>00170 
<anchor xml:id="__pre_charge_8ino_source_1l00171"/>00171 &#32;&#32;<emphasis role="comment">/*&#32;!!!!&#32;these&#32;are&#32;commented&#32;out&#32;now&#32;but&#32;all&#32;of&#32;this&#32;should&#32;be&#32;checked&#32;when&#32;using&#32;the&#32;real&#32;bike&#32;!!!!</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00172"/>00172 <emphasis role="comment">&#32;&#32;&#32;&#32;though&#32;you&#32;will&#32;have&#32;to&#32;determine&#32;which&#32;of&#32;these&#32;are&#32;emergency&#32;HV&#32;states.&#32;i.e.&#32;Which&#32;ones&#32;should&#32;turn&#32;off&#32;the&#32;contactor&#32;instantly</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00173"/>00173 <emphasis role="comment">&#32;&#32;&#32;&#32;and&#32;which&#32;ones&#32;should&#32;you&#32;simply&#32;alert&#32;the&#32;rider?</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00174"/>00174 <emphasis role="comment">&#32;&#32;&#32;&#32;As&#32;of&#32;now,&#32;they&#32;all&#32;immediately&#32;turn&#32;off&#32;the&#32;contactor&#32;which&#32;may&#32;be&#32;dangerous&#32;for&#32;the&#32;rider</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00175"/>00175 <emphasis role="comment">&#32;&#32;*/</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00176"/>00176 
<anchor xml:id="__pre_charge_8ino_source_1l00177"/>00177 &#32;&#32;<emphasis role="comment">//if&#32;(*bmsStatus.ltc_fault&#32;==&#32;1)&#32;return&#32;0;</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00178"/>00178 &#32;&#32;<emphasis role="comment">//if&#32;(*bmsStatus.ltc_count&#32;!=&#32;NUMBER_OF_LTCS)&#32;return&#32;0;</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00179"/>00179 &#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;&#32;the&#32;below&#32;if&#32;can&#32;be&#32;reduced&#32;to&#32;if&#32;(*bmsStatus.bms_c_fault)&#32;which&#32;returns&#32;true&#32;for&#32;any&#32;non-zero&#32;bms_c_fault&#32;value</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00180"/>00180 &#32;&#32;<emphasis role="comment">//if&#32;(*bmsStatus.bms_c_fault&#32;==&#32;1&#32;||&#32;*bmsStatus.bms_c_fault&#32;==&#32;2&#32;||&#32;*bmsStatus.bms_c_fault&#32;==&#32;4&#32;||&#32;&#32;&#32;&#32;//checks&#32;BMS&#32;fault&#32;error&#32;codes</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00181"/>00181 &#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;&#32;*bmsStatus.bms_c_fault&#32;==&#32;8)&#32;return&#32;0;</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00182"/>00182 &#32;&#32;<emphasis role="comment">//if&#32;(*bmsStatus.bms_status_flag&#32;==&#32;1&#32;||&#32;*bmsStatus.bms_status_flag&#32;==&#32;2)&#32;return&#32;0;&#32;&#32;//check&#32;if&#32;cells&#32;are&#32;above&#32;or&#32;below&#32;the&#32;voltage&#32;cutoffs</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00183"/>00183 &#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(*<link linkend="__main_8h_1abb61c6dc61d12b31aad7bdadd495b70a">motorTemps</link>.<link linkend="_struct_motor_temps_1a1c8b1bb77f968573fe2d1af0a0815d35">motorControllerTemperature</link>&#32;&gt;=&#32;<link linkend="__precharge_8h_1a1f9513787cfe256aae379719ab26ca39">MOTORCONTROLLER_TEMP_MAX</link>
<anchor xml:id="__pre_charge_8ino_source_1l00184"/>00184 &#32;&#32;&#32;&#32;&#32;&#32;||&#32;*<link linkend="__main_8h_1abb61c6dc61d12b31aad7bdadd495b70a">motorTemps</link>.<link linkend="_struct_motor_temps_1ad9864aa48ce76c5965919c459cc6e9b7">motorTemperature</link>&#32;&gt;=&#32;<link linkend="__precharge_8h_1aa39f17be3d8f2f799f7fbd0dc01963db">MOTOR_TEMP_MAX</link>)&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;0;
<anchor xml:id="__pre_charge_8ino_source_1l00185"/>00185 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;1;
<anchor xml:id="__pre_charge_8ino_source_1l00186"/>00186 }
<anchor xml:id="__pre_charge_8ino_source_1l00187"/>00187 
<anchor xml:id="__pre_charge_8ino_source_1l00188"/><link linkend="__precharge_8h_1a6798f4bd0a5b6353886f894b38b32473">00188</link> <emphasis role="keywordtype">bool</emphasis>&#32;<link linkend="__pre_charge_8ino_1a6798f4bd0a5b6353886f894b38b32473">check_HV_TOGGLE</link>()&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00189"/>00189 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;!digitalRead(<link linkend="__precharge_8h_1a4e1dc017df18faad4234012c3e88d2f6">HIGH_VOLTAGE_TOGGLE</link>);
<anchor xml:id="__pre_charge_8ino_source_1l00190"/>00190 }
<anchor xml:id="__pre_charge_8ino_source_1l00191"/>00191 
<anchor xml:id="__pre_charge_8ino_source_1l00192"/><link linkend="__precharge_8h_1a0a3e1d4e80c1320d3308a0e0bb10ac87">00192</link> <emphasis role="keywordtype">char</emphasis>*&#32;<link linkend="__pre_charge_8ino_1a0a3e1d4e80c1320d3308a0e0bb10ac87">state_name</link>(<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29">HV_STATE</link>&#32;state)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00193"/>00193 &#32;&#32;<emphasis role="keywordflow">switch</emphasis>&#32;(state)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00194"/>00194 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29abc9f85ed087d13faf9b1c463431ee66a">HV_OFF</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="stringliteral">&quot;HV_OFF&quot;</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00195"/>00195 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2da9fa3988c31a60d94ee2a751ba32ce">HV_PRECHARGING</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="stringliteral">&quot;HV_PRECHARGING&quot;</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00196"/>00196 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29ab5febf14562b68ff6bdaaa86ec9b5dec">HV_ON</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="stringliteral">&quot;HV_ON&quot;</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00197"/>00197 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">case</emphasis>&#32;<link linkend="__precharge_8h_1a5faacefaff4b0ce77f1f8be0bf2aaf29a2303713b8a2ce365abb6b0de95c38595">HV_ERROR</link>:&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="stringliteral">&quot;HV_ERROR&quot;</emphasis>;
<anchor xml:id="__pre_charge_8ino_source_1l00198"/>00198 &#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00199"/>00199 }
<anchor xml:id="__pre_charge_8ino_source_1l00200"/>00200 
<anchor xml:id="__pre_charge_8ino_source_1l00201"/><link linkend="__precharge_8h_1a5782bd590f95fb2269eb43a3d70c18f4">00201</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1a5782bd590f95fb2269eb43a3d70c18f4">setupI2C</link>(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00202"/>00202 &#32;&#32;Wire.setClock(400000);&#32;<emphasis role="comment">//&#32;MPU6050&#32;supports&#32;up&#32;to&#32;400k&#32;Hz&#32;in&#32;specifications</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00203"/>00203 &#32;&#32;Wire.begin();
<anchor xml:id="__pre_charge_8ino_source_1l00204"/>00204 &#32;&#32;delay(50);&#32;<emphasis role="comment">//&#32;give&#32;delay&#32;for&#32;device&#32;to&#32;start</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00205"/>00205 
<anchor xml:id="__pre_charge_8ino_source_1l00206"/>00206 &#32;&#32;<emphasis role="comment">//&#32;Start&#32;gyro&#32;in&#32;power&#32;mode</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00207"/>00207 &#32;&#32;Wire.beginTransmission(0x68);
<anchor xml:id="__pre_charge_8ino_source_1l00208"/>00208 &#32;&#32;Wire.write(0x6B);&#32;<emphasis role="comment">//&#32;6B&#32;is&#32;relevant&#32;register</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00209"/>00209 &#32;&#32;Wire.write(0x00);&#32;<emphasis role="comment">//&#32;all&#32;bits&#32;must&#32;be&#32;0&#32;to&#32;start&#32;and&#32;continue&#32;device</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00210"/>00210 &#32;&#32;Wire.endTransmission();
<anchor xml:id="__pre_charge_8ino_source_1l00211"/>00211 
<anchor xml:id="__pre_charge_8ino_source_1l00212"/>00212 &#32;&#32;<emphasis role="comment">//&#32;Perform&#32;gyroscope&#32;calibration&#32;measurements</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00213"/>00213 &#32;&#32;<emphasis role="comment">//&#32;2000&#32;milliseconds&#32;=&#32;2&#32;seconds&#32;to&#32;add&#32;all&#32;measured&#32;variables&#32;to&#32;calibration&#32;variables</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00214"/>00214 &#32;&#32;<emphasis role="comment">//&#32;This&#32;is&#32;important&#32;because&#32;this&#32;solves&#32;the&#32;issue&#32;of&#32;a&#32;non-zero&#32;rotation&#32;rate&#32;when&#32;stationary</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00215"/>00215 &#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1ab12a4f264d6acfdf84ce67728ecb42b2">RateCalibrationNumber</link>&#32;=&#32;0;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1ab12a4f264d6acfdf84ce67728ecb42b2">RateCalibrationNumber</link>&#32;&lt;&#32;2000;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1ab12a4f264d6acfdf84ce67728ecb42b2">RateCalibrationNumber</link>++)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00216"/>00216 &#32;&#32;&#32;&#32;<link linkend="__pre_charge_8ino_1ad8511ef84de5112bd6beb8e3ac5fff67">gyro_signals</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>);
<anchor xml:id="__pre_charge_8ino_source_1l00217"/>00217 &#32;&#32;&#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4d7799e4a73f6488e3296c35f66c2e30">RateCalibrationRoll</link>&#32;+=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a33b675970bf11d7e27edf3b542431997">RateRoll</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00218"/>00218 &#32;&#32;&#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a80f6f899a8c9d6b3e7850f52350a414d">RateCalibrationPitch</link>&#32;+=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afc133d30f22f7a7f72ee498b3d69be82">RatePitch</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00219"/>00219 &#32;&#32;&#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aa0d6bb3b938787ae1de06d67d1e3deaf">RateCalibrationYaw</link>&#32;+=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aaf5cdfb5b1dd1857d4082f3a014ffb51">RateYaw</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00220"/>00220 &#32;&#32;&#32;&#32;delay(1);
<anchor xml:id="__pre_charge_8ino_source_1l00221"/>00221 &#32;&#32;}
<anchor xml:id="__pre_charge_8ino_source_1l00222"/>00222 
<anchor xml:id="__pre_charge_8ino_source_1l00223"/>00223 &#32;&#32;<emphasis role="comment">//&#32;Take&#32;average&#32;of&#32;calibrated&#32;rotation&#32;rate&#32;values&#32;from&#32;each&#32;direction</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00224"/>00224 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4d7799e4a73f6488e3296c35f66c2e30">RateCalibrationRoll</link>&#32;/=&#32;2000;
<anchor xml:id="__pre_charge_8ino_source_1l00225"/>00225 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a80f6f899a8c9d6b3e7850f52350a414d">RateCalibrationPitch</link>&#32;/=&#32;2000;
<anchor xml:id="__pre_charge_8ino_source_1l00226"/>00226 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aa0d6bb3b938787ae1de06d67d1e3deaf">RateCalibrationYaw</link>&#32;/=&#32;2000;
<anchor xml:id="__pre_charge_8ino_source_1l00227"/>00227 &#32;&#32;<emphasis role="comment">//&#32;&#32;*preChargeData.LoopTimer&#32;=&#32;micros();</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00228"/>00228 }
<anchor xml:id="__pre_charge_8ino_source_1l00229"/>00229 
<anchor xml:id="__pre_charge_8ino_source_1l00230"/><link linkend="__precharge_8h_1ad8511ef84de5112bd6beb8e3ac5fff67">00230</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1ad8511ef84de5112bd6beb8e3ac5fff67">gyro_signals</link>(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00231"/>00231 &#32;&#32;<emphasis role="comment">//&#32;Start&#32;I2C&#32;communication&#32;with&#32;MPU6050</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00232"/>00232 &#32;&#32;Wire.beginTransmission(0x68);&#32;<emphasis role="comment">//&#32;0x68&#32;is&#32;default&#32;register&#32;value&#32;for&#32;MPU6050</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00233"/>00233 
<anchor xml:id="__pre_charge_8ino_source_1l00234"/>00234 &#32;&#32;<emphasis role="comment">//&#32;Switch&#32;on&#32;low&#32;pass&#32;filter</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00235"/>00235 &#32;&#32;Wire.write(0x1A);&#32;<emphasis role="comment">//&#32;activate&#32;low&#32;pass&#32;filter</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00236"/>00236 &#32;&#32;Wire.write(0x05);&#32;<emphasis role="comment">//&#32;cut&#32;off&#32;frequency&#32;of&#32;10&#32;Hz</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00237"/>00237 &#32;&#32;Wire.endTransmission();
<anchor xml:id="__pre_charge_8ino_source_1l00238"/>00238 
<anchor xml:id="__pre_charge_8ino_source_1l00239"/>00239 &#32;&#32;<emphasis role="comment">//&#32;Configure&#32;accelerometer&#32;output</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00240"/>00240 &#32;&#32;Wire.beginTransmission(0x68);
<anchor xml:id="__pre_charge_8ino_source_1l00241"/>00241 &#32;&#32;Wire.write(0x1C);&#32;<emphasis role="comment">//&#32;1C&#32;is&#32;relevant&#32;register</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00242"/>00242 &#32;&#32;Wire.write(0x10);&#32;<emphasis role="comment">//&#32;full&#32;scale&#32;range&#32;of&#32;+/-8g</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00243"/>00243 &#32;&#32;Wire.endTransmission();
<anchor xml:id="__pre_charge_8ino_source_1l00244"/>00244 
<anchor xml:id="__pre_charge_8ino_source_1l00245"/>00245 &#32;&#32;<emphasis role="comment">//&#32;Access&#32;registers&#32;storing&#32;accelerometer&#32;measurements</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00246"/>00246 &#32;&#32;Wire.beginTransmission(0x68);
<anchor xml:id="__pre_charge_8ino_source_1l00247"/>00247 &#32;&#32;Wire.write(0x3B);
<anchor xml:id="__pre_charge_8ino_source_1l00248"/>00248 &#32;&#32;Wire.endTransmission();
<anchor xml:id="__pre_charge_8ino_source_1l00249"/>00249 &#32;&#32;Wire.requestFrom(0x68,&#32;6);
<anchor xml:id="__pre_charge_8ino_source_1l00250"/>00250 
<anchor xml:id="__pre_charge_8ino_source_1l00251"/>00251 &#32;&#32;<emphasis role="comment">//&#32;Read&#32;accelerometer&#32;measurements</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00252"/>00252 &#32;&#32;int16_t&#32;AccXLSB&#32;=&#32;Wire.read()&#32;&lt;&lt;&#32;8&#32;|&#32;Wire.read();&#32;<emphasis role="comment">//&#32;x-direction</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00253"/>00253 &#32;&#32;int16_t&#32;AccYLSB&#32;=&#32;Wire.read()&#32;&lt;&lt;&#32;8&#32;|&#32;Wire.read();&#32;<emphasis role="comment">//&#32;y-direction</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00254"/>00254 &#32;&#32;int16_t&#32;AccZLSB&#32;=&#32;Wire.read()&#32;&lt;&lt;&#32;8&#32;|&#32;Wire.read();&#32;<emphasis role="comment">//&#32;z-direction</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00255"/>00255 
<anchor xml:id="__pre_charge_8ino_source_1l00256"/>00256 &#32;&#32;<emphasis role="comment">//&#32;Configure&#32;gyroscope&#32;output&#32;and&#32;pull&#32;rotation&#32;rate&#32;measurements&#32;from&#32;sensor</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00257"/>00257 &#32;&#32;<emphasis role="comment">//&#32;Set&#32;sensitivity&#32;scale&#32;factor</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00258"/>00258 &#32;&#32;Wire.beginTransmission(0x68);
<anchor xml:id="__pre_charge_8ino_source_1l00259"/>00259 &#32;&#32;Wire.write(0x1B);&#32;<emphasis role="comment">//&#32;1B&#32;is&#32;hexadecimal&#32;associated&#32;with&#32;gyroscope&#32;configuration</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00260"/>00260 &#32;&#32;Wire.write(0x8);&#32;<emphasis role="comment">//&#32;8&#32;is&#32;hexadecimal&#32;for&#32;LSB&#32;sensitivity&#32;of&#32;65.6&#32;LSB/degree/second</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00261"/>00261 &#32;&#32;Wire.endTransmission();
<anchor xml:id="__pre_charge_8ino_source_1l00262"/>00262 
<anchor xml:id="__pre_charge_8ino_source_1l00263"/>00263 &#32;&#32;<emphasis role="comment">//&#32;Access&#32;registers&#32;storing&#32;gyro&#32;measurements</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00264"/>00264 &#32;&#32;Wire.beginTransmission(0x68);
<anchor xml:id="__pre_charge_8ino_source_1l00265"/>00265 &#32;&#32;Wire.write(0x43);
<anchor xml:id="__pre_charge_8ino_source_1l00266"/>00266 &#32;&#32;Wire.endTransmission();
<anchor xml:id="__pre_charge_8ino_source_1l00267"/>00267 &#32;&#32;Wire.requestFrom(0x68,&#32;6);
<anchor xml:id="__pre_charge_8ino_source_1l00268"/>00268 
<anchor xml:id="__pre_charge_8ino_source_1l00269"/>00269 &#32;&#32;<emphasis role="comment">//&#32;Read&#32;gyro&#32;measurements</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00270"/>00270 &#32;&#32;int16_t&#32;GyroX&#32;=&#32;Wire.read()&#32;&lt;&lt;&#32;8&#32;|&#32;Wire.read();&#32;<emphasis role="comment">//&#32;around&#32;x-axis</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00271"/>00271 &#32;&#32;int16_t&#32;GyroY&#32;=&#32;Wire.read()&#32;&lt;&lt;&#32;8&#32;|&#32;Wire.read();&#32;<emphasis role="comment">//&#32;around&#32;y-axis</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00272"/>00272 &#32;&#32;int16_t&#32;GyroZ&#32;=&#32;Wire.read()&#32;&lt;&lt;&#32;8&#32;|&#32;Wire.read();&#32;<emphasis role="comment">//&#32;around&#32;z-axis</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00273"/>00273 
<anchor xml:id="__pre_charge_8ino_source_1l00274"/>00274 &#32;&#32;<emphasis role="comment">//&#32;Convert&#32;measurement&#32;units&#32;to&#32;degree/second</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00275"/>00275 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a33b675970bf11d7e27edf3b542431997">RateRoll</link>&#32;=&#32;(float)GyroX&#32;/&#32;65.5;
<anchor xml:id="__pre_charge_8ino_source_1l00276"/>00276 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afc133d30f22f7a7f72ee498b3d69be82">RatePitch</link>&#32;=&#32;(float)GyroY&#32;/&#32;65.5;
<anchor xml:id="__pre_charge_8ino_source_1l00277"/>00277 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aaf5cdfb5b1dd1857d4082f3a014ffb51">RateYaw</link>&#32;=&#32;(float)GyroZ&#32;/&#32;65.5;
<anchor xml:id="__pre_charge_8ino_source_1l00278"/>00278 
<anchor xml:id="__pre_charge_8ino_source_1l00279"/>00279 &#32;&#32;<emphasis role="comment">//&#32;Convert&#32;measurements&#32;to&#32;from&#32;LSB&#32;to&#32;g</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00280"/>00280 &#32;&#32;<emphasis role="comment">//&#32;Divide&#32;4096&#32;because&#32;full&#32;range&#32;+/-8g&#32;is&#32;associated&#32;with&#32;4096&#32;LSB/g</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00281"/>00281 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a3c051d79159770c924eda82743ba8d81">AccX</link>&#32;=&#32;(float)AccXLSB&#32;/&#32;4096;
<anchor xml:id="__pre_charge_8ino_source_1l00282"/>00282 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a80f0e6e50839ffb0fc6d04cd3d871a3f">AccY</link>&#32;=&#32;(float)AccYLSB&#32;/&#32;4096;
<anchor xml:id="__pre_charge_8ino_source_1l00283"/>00283 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a3bb9585d2c3e9ee02ed1f98f706426b3">AccZ</link>&#32;=&#32;(float)AccZLSB&#32;/&#32;4096;
<anchor xml:id="__pre_charge_8ino_source_1l00284"/>00284 
<anchor xml:id="__pre_charge_8ino_source_1l00285"/>00285 &#32;&#32;<emphasis role="keywordtype">float</emphasis>&#32;AccX&#32;=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a3c051d79159770c924eda82743ba8d81">AccX</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00286"/>00286 &#32;&#32;<emphasis role="keywordtype">float</emphasis>&#32;AccY&#32;=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a80f0e6e50839ffb0fc6d04cd3d871a3f">AccY</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00287"/>00287 &#32;&#32;<emphasis role="keywordtype">float</emphasis>&#32;AccZ&#32;=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a3bb9585d2c3e9ee02ed1f98f706426b3">AccZ</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00288"/>00288 
<anchor xml:id="__pre_charge_8ino_source_1l00289"/>00289 &#32;&#32;<emphasis role="comment">//&#32;Calculate&#32;absolute&#32;angles</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00290"/>00290 &#32;&#32;<emphasis role="comment">//&#32;IMPORTANT&#32;LINE&#32;OF&#32;CODE:</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00291"/>00291 &#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;&#32;-&#32;WE&#32;CAN&#32;ADD&#32;OR&#32;SUBTRACT&#32;FROM&#32;THE&#32;ANGLE&#32;DEPENDING&#32;ON&#32;THE&#32;PLACEMENT&#32;OF&#32;GYROSCOPE</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00292"/>00292 &#32;&#32;<emphasis role="comment">//&#32;&#32;&#32;&#32;-&#32;EX:&#32;If&#32;MPU6050&#32;is&#32;laid&#32;on&#32;port&#32;side,&#32;add&#32;90&#32;to&#32;AnglePitch</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00293"/>00293 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a99d4f80bc2e399c388039183debf146a">AngleRoll</link>&#32;=&#32;(atan(AccY&#32;/&#32;sqrt(AccX&#32;*&#32;AccX&#32;+&#32;AccZ&#32;*&#32;AccZ))&#32;*&#32;1&#32;/&#32;(3.142&#32;/&#32;180))&#32;+&#32;5;
<anchor xml:id="__pre_charge_8ino_source_1l00294"/>00294 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4bb0f04e326928d80e286b279ca81003">AnglePitch</link>&#32;=&#32;(-atan(AccX&#32;/&#32;sqrt(AccY&#32;*&#32;AccY&#32;+&#32;AccZ&#32;*&#32;AccZ))&#32;*&#32;1&#32;/&#32;(3.142&#32;/&#32;180));
<anchor xml:id="__pre_charge_8ino_source_1l00295"/>00295 }
<anchor xml:id="__pre_charge_8ino_source_1l00296"/>00296 
<anchor xml:id="__pre_charge_8ino_source_1l00297"/><link linkend="__precharge_8h_1a87184d718be6821c71e697fc1fd98d3b">00297</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1a87184d718be6821c71e697fc1fd98d3b">updateGyroData</link>(<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00298"/>00298 &#32;&#32;<link linkend="__pre_charge_8ino_1ad8511ef84de5112bd6beb8e3ac5fff67">gyro_signals</link>(<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>);
<anchor xml:id="__pre_charge_8ino_source_1l00299"/>00299 
<anchor xml:id="__pre_charge_8ino_source_1l00300"/>00300 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a33b675970bf11d7e27edf3b542431997">RateRoll</link>&#32;-=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4d7799e4a73f6488e3296c35f66c2e30">RateCalibrationRoll</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00301"/>00301 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afc133d30f22f7a7f72ee498b3d69be82">RatePitch</link>&#32;-=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a80f6f899a8c9d6b3e7850f52350a414d">RateCalibrationPitch</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00302"/>00302 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aaf5cdfb5b1dd1857d4082f3a014ffb51">RateYaw</link>&#32;-=&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1aa0d6bb3b938787ae1de06d67d1e3deaf">RateCalibrationYaw</link>;
<anchor xml:id="__pre_charge_8ino_source_1l00303"/>00303 
<anchor xml:id="__pre_charge_8ino_source_1l00304"/>00304 &#32;&#32;<emphasis role="comment">//&#32;Calculate&#32;Roll&#32;angle&#32;(around&#32;x&#32;axis)</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00305"/>00305 &#32;&#32;<link linkend="__pre_charge_8ino_1ade8f654468b951602d2622b34902944f">kalman_1d</link>(*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a53289d52f48c067285cb843ef7470c9a">angle_X</link>,&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a56b12f35d375a77d39a5067b35701ec6">KalmanUncertaintyAngleRoll</link>,&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a33b675970bf11d7e27edf3b542431997">RateRoll</link>,&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a99d4f80bc2e399c388039183debf146a">AngleRoll</link>,&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>);
<anchor xml:id="__pre_charge_8ino_source_1l00306"/>00306 
<anchor xml:id="__pre_charge_8ino_source_1l00307"/>00307 &#32;&#32;<emphasis role="comment">//&#32;Update&#32;Kalman&#32;output&#32;to&#32;angle&#32;roll&#32;and&#32;uncertaintity</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00308"/>00308 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a53289d52f48c067285cb843ef7470c9a">angle_X</link>&#32;=&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4ca4aeeb66f8fa86b2b33287d78f8174">Kalman1DOutput</link>[0];
<anchor xml:id="__pre_charge_8ino_source_1l00309"/>00309 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a56b12f35d375a77d39a5067b35701ec6">KalmanUncertaintyAngleRoll</link>&#32;=&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4ca4aeeb66f8fa86b2b33287d78f8174">Kalman1DOutput</link>[1];
<anchor xml:id="__pre_charge_8ino_source_1l00310"/>00310 
<anchor xml:id="__pre_charge_8ino_source_1l00311"/>00311 &#32;&#32;<emphasis role="comment">//&#32;Calculate&#32;Pitch&#32;angle&#32;(around&#32;y-axis)</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00312"/>00312 &#32;&#32;<link linkend="__pre_charge_8ino_1ade8f654468b951602d2622b34902944f">kalman_1d</link>(*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a7a48fc6887285d4cb55bff65fca23f36">angle_Y</link>,&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a87db2a0a7add2863f02e490544f937b2">KalmanUncertaintyAnglePitch</link>,&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1afc133d30f22f7a7f72ee498b3d69be82">RatePitch</link>,&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4bb0f04e326928d80e286b279ca81003">AnglePitch</link>,&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>);
<anchor xml:id="__pre_charge_8ino_source_1l00313"/>00313 
<anchor xml:id="__pre_charge_8ino_source_1l00314"/>00314 &#32;&#32;<emphasis role="comment">//&#32;Update&#32;Kalman&#32;output&#32;to&#32;angle&#32;pitch&#32;and&#32;uncertaintity</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00315"/>00315 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a7a48fc6887285d4cb55bff65fca23f36">angle_Y</link>&#32;=&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4ca4aeeb66f8fa86b2b33287d78f8174">Kalman1DOutput</link>[0];
<anchor xml:id="__pre_charge_8ino_source_1l00316"/>00316 &#32;&#32;*<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a87db2a0a7add2863f02e490544f937b2">KalmanUncertaintyAnglePitch</link>&#32;=&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4ca4aeeb66f8fa86b2b33287d78f8174">Kalman1DOutput</link>[1];
<anchor xml:id="__pre_charge_8ino_source_1l00317"/>00317 }
<anchor xml:id="__pre_charge_8ino_source_1l00318"/>00318 
<anchor xml:id="__pre_charge_8ino_source_1l00319"/><link linkend="__precharge_8h_1ade8f654468b951602d2622b34902944f">00319</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="__pre_charge_8ino_1ade8f654468b951602d2622b34902944f">kalman_1d</link>(<emphasis role="keywordtype">float</emphasis>&#32;KalmanState,&#32;<emphasis role="keywordtype">float</emphasis>&#32;KalmanUncertainty,&#32;<emphasis role="keywordtype">float</emphasis>&#32;KalmanInput,&#32;<emphasis role="keywordtype">float</emphasis>&#32;KalmanMeasurement,&#32;<link linkend="_struct_pre_charge_task_data">PreChargeTaskData</link>&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>)&#32;{
<anchor xml:id="__pre_charge_8ino_source_1l00320"/>00320 &#32;&#32;KalmanState&#32;=&#32;KalmanState&#32;+&#32;0.004&#32;*&#32;KalmanInput;
<anchor xml:id="__pre_charge_8ino_source_1l00321"/>00321 &#32;&#32;KalmanUncertainty&#32;=&#32;KalmanUncertainty&#32;+&#32;0.004&#32;*&#32;0.004&#32;*&#32;4&#32;*&#32;4;
<anchor xml:id="__pre_charge_8ino_source_1l00322"/>00322 &#32;&#32;<emphasis role="keywordtype">float</emphasis>&#32;KalmanGain&#32;=&#32;KalmanUncertainty&#32;*&#32;1&#32;/&#32;(1&#32;*&#32;KalmanUncertainty&#32;+&#32;3&#32;*&#32;3);
<anchor xml:id="__pre_charge_8ino_source_1l00323"/>00323 &#32;&#32;KalmanState&#32;=&#32;KalmanState&#32;+&#32;KalmanGain&#32;*&#32;(KalmanMeasurement&#32;-&#32;KalmanState);
<anchor xml:id="__pre_charge_8ino_source_1l00324"/>00324 &#32;&#32;KalmanUncertainty&#32;=&#32;(1&#32;-&#32;KalmanGain)&#32;*&#32;KalmanUncertainty;
<anchor xml:id="__pre_charge_8ino_source_1l00325"/>00325 &#32;&#32;<emphasis role="comment">//&#32;Output&#32;of&#32;filter</emphasis>
<anchor xml:id="__pre_charge_8ino_source_1l00326"/>00326 &#32;&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4ca4aeeb66f8fa86b2b33287d78f8174">Kalman1DOutput</link>[0]&#32;=&#32;KalmanState;
<anchor xml:id="__pre_charge_8ino_source_1l00327"/>00327 &#32;&#32;<link linkend="__main_8h_1a695dccac97a0f45cf570237e981b2b5d">preChargeData</link>.<link linkend="_struct_pre_charge_task_data_1a4ca4aeeb66f8fa86b2b33287d78f8174">Kalman1DOutput</link>[1]&#32;=&#32;KalmanUncertainty;
<anchor xml:id="__pre_charge_8ino_source_1l00328"/>00328 }
</programlisting></section>
